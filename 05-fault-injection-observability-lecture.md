# ç¬¬äº”ç« ï¼šæ•…éšœæ³¨å…¥ä¸å¯è§‚æµ‹æ€§ â€”â€” æå‰å‘ç°é—®é¢˜

> **ç« èŠ‚ç›®æ ‡**ï¼šç†è§£å¦‚ä½•åœ¨ç”Ÿäº§å‰å®‰å…¨åœ°æµ‹è¯•ç³»ç»Ÿçš„å®¹é”™èƒ½åŠ›ï¼ŒæŒæ¡æµé‡é•œåƒã€æ•…éšœæ³¨å…¥ã€è°ƒè¯•ä¸è¯Šæ–­çš„å®Œæ•´å·¥å…·é“¾ã€‚

---

## 1. ä¸ºä»€ä¹ˆéœ€è¦æå‰æ³¨å…¥æ•…éšœï¼Ÿ

### ä¼ ç»Ÿæµ‹è¯•çš„å›°å¢ƒ

```
ä¼ ç»Ÿ QA æµ‹è¯•ï¼š
åœ¨å®Œå…¨æ¨¡æ‹Ÿç¯å¢ƒä¸­æ„é€ æ•…éšœåœºæ™¯
   â†“
ä½†æ¨¡æ‹Ÿç¯å¢ƒå¾€å¾€ï¼š
â€¢ æµé‡æ¨¡å¼ä¸ç”Ÿäº§ç¯å¢ƒä¸ç¬¦
â€¢ å¹¶å‘æ•°è¿œä½äºç”Ÿäº§ç¯å¢ƒ
â€¢ ç½‘ç»œå»¶è¿Ÿã€ä¸¢åŒ…ä¸çœŸå®
   â†“
ç»“æœï¼šæµ‹è¯•é€šè¿‡ â†’ ç”Ÿäº§æ•…éšœï¼
```

**è‘—åæ¡ˆä¾‹ï¼šNetflix çš„ Chaos Monkey**

Netflix åœ¨ç”Ÿäº§ç¯å¢ƒä¸­**ä¸»åŠ¨æ€æ­»æœåŠ¡å®ä¾‹**ï¼Œæ¥éªŒè¯è‡ªåŠ¨æ•…éšœè½¬ç§»æ˜¯å¦æœ‰æ•ˆã€‚è¿™ä¸ªæ¿€è¿›çš„åšæ³•åæ¥æ¼”å˜æˆ"æ··æ²Œå·¥ç¨‹"ã€‚

### Istio æ•…éšœæ³¨å…¥çš„ä¼˜åŠ¿

Istio åœ¨ç½‘æ ¼å±‚æ³¨å…¥æ•…éšœï¼Œæœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

```
ä¼˜åŠ¿ 1ï¼šæ— éœ€ä¿®æ”¹åº”ç”¨ä»£ç 
  â”œâ”€ æ•…éšœæ³¨å…¥å®Œå…¨åœ¨ Envoy é…ç½®
  â””â”€ åº”ç”¨æ— æ„ŸçŸ¥

ä¼˜åŠ¿ 2ï¼šå¯ä»¥ç²¾ç»†åŒ–æ§åˆ¶
  â”œâ”€ æŒ‰ç™¾åˆ†æ¯”æ³¨å…¥ï¼ˆ10% è¯·æ±‚å»¶è¿Ÿï¼‰
  â”œâ”€ æŒ‰ Header åŒ¹é…æ³¨å…¥ï¼ˆç‰¹å®šç”¨æˆ·ç»„ï¼‰
  â””â”€ å¤šä¸ªæ•…éšœåŒæ—¶æ³¨å…¥ï¼ˆå»¶è¿Ÿ + é”™è¯¯ï¼‰

ä¼˜åŠ¿ 3ï¼šå¿«é€ŸéªŒè¯
  â”œâ”€ éƒ¨ç½² YAML ç«‹å³ç”Ÿæ•ˆï¼ˆæ— éœ€é‡å¯åº”ç”¨ï¼‰
  â””â”€ å¯ä»¥å¿«é€Ÿè°ƒæ•´å‚æ•°

ä¼˜åŠ¿ 4ï¼šçœŸå®çš„ç”Ÿäº§æµé‡
  â”œâ”€ å¯ä»¥åœ¨çœŸå®é›†ç¾¤ä¸Šæµ‹è¯•
  â”œâ”€ çœŸå®çš„å¹¶å‘ã€çœŸå®çš„ç½‘ç»œ
  â””â”€ æ¯”æ¨¡æ‹Ÿç¯å¢ƒæ›´å¯ä¿¡
```

---

## 2. æ•…éšœæ³¨å…¥ï¼šå»¶è¿Ÿä¸é”™è¯¯

### æ•…éšœæ³¨å…¥çš„ä¸¤ç§ç±»å‹

Istio æ”¯æŒä¸¤ç§æ•…éšœæ³¨å…¥ï¼š

```
1. Delayï¼ˆå»¶è¿Ÿï¼‰
   â”œâ”€ æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿæˆ–æ…¢æœåŠ¡
   â”œâ”€ ç”¨æ¥æµ‹è¯•è¶…æ—¶å’Œé‡è¯•æœºåˆ¶
   â””â”€ é€šå¸¸ä¸ä¼šå¯¼è‡´é”™è¯¯

2. Abortï¼ˆä¸­æ­¢ï¼‰
   â”œâ”€ æ¨¡æ‹ŸæœåŠ¡æ•…éšœï¼ˆè¿”å›ç‰¹å®š HTTP çŠ¶æ€ç ï¼‰
   â”œâ”€ ç”¨æ¥æµ‹è¯•é”™è¯¯å¤„ç†å’Œç†”æ–­
   â””â”€ å¯ä»¥è¿”å›ä»»ä½• HTTP çŠ¶æ€ç ï¼ˆ500ã€503 ç­‰ï¼‰
```

### å»¶è¿Ÿæ³¨å…¥ï¼ˆDelayï¼‰

**åœºæ™¯ï¼š** ä½ æƒ³éªŒè¯åº”ç”¨åœ¨ç½‘ç»œå»¶è¿Ÿé«˜çš„æƒ…å†µä¸‹æ˜¯å¦æ­£å¸¸ã€‚

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - fault:
      delay:
        percentage: 10             # 10% çš„è¯·æ±‚è¢«å»¶è¿Ÿ
        fixedDelay: 5s             # å»¶è¿Ÿ 5 ç§’
    route:
    - destination:
        host: reviews
```

**å·¥ä½œæµç¨‹ï¼š**

```
å®¢æˆ·ç«¯å‘é€è¯·æ±‚
   â†“
Envoy æ‹¦æˆªè¯·æ±‚
   â†“
ç”Ÿæˆéšæœºæ•° 0-100
   â”œâ”€ è‹¥ â‰¤ 10 â†’ è¿›å…¥"å»¶è¿Ÿæ¨¡å¼"
   â”‚  â”œâ”€ ç­‰å¾… 5 ç§’ï¼ˆä¸å¤„ç†è¯·æ±‚ï¼‰
   â”‚  â””â”€ 5 ç§’åæ‰è½¬å‘ç»™åç«¯
   â”‚
   â””â”€ è‹¥ > 10 â†’ æ­£å¸¸è½¬å‘

åç«¯å¤„ç†å¹¶å“åº”
   â†“
Envoy è¿”å›å“åº”ï¼ˆæ€»è€—æ—¶è‡³å°‘ 5 ç§’ï¼‰
```

**å»¶è¿Ÿæ³¨å…¥çš„å®é™…æ•ˆæœï¼š**

```
åŸæœ¬è€—æ—¶åˆ†å¸ƒï¼š
GET /reviews â†’ 50ms, 55ms, 52msï¼ˆå¹³å‡ 50msï¼‰

æ³¨å…¥ 10% å»¶è¿Ÿ 5s åï¼š
GET /reviews â†’ 50ms, 5000msï¼ˆå»¶è¿Ÿï¼ï¼‰, 55ms, 5050ms, 52ms
                        â†‘
                   è¿™ä¸€ä¸ªè¯·æ±‚è¶…æ—¶ï¼ï¼ˆå¦‚æœè¶…æ—¶è®¾ç½® < 5sï¼‰
```

**é…ç½®å»ºè®®ï¼š**

```yaml
fault:
  delay:
    percentage: 5              # 5%ï¼šè¶³ä»¥æµ‹è¯•ï¼Œä¸ä¼šè¿‡åº¦å½±å“
    fixedDelay: 500ms          # 500msï¼šæµ‹è¯•å…¸å‹ç½‘ç»œå»¶è¿Ÿ
```

### é”™è¯¯æ³¨å…¥ï¼ˆAbortï¼‰

**åœºæ™¯ï¼š** ä½ æƒ³éªŒè¯åº”ç”¨åœ¨åç«¯è¿”å› 500 é”™è¯¯æ—¶çš„è¡¨ç°ã€‚

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - fault:
      abort:
        percentage: 5              # 5% çš„è¯·æ±‚è¿”å›é”™è¯¯
        httpStatus: 500            # è¿”å› HTTP 500
    route:
    - destination:
        host: reviews
```

**å·¥ä½œæµç¨‹ï¼š**

```
å®¢æˆ·ç«¯å‘é€è¯·æ±‚
   â†“
Envoy æ‹¦æˆªè¯·æ±‚
   â†“
ç”Ÿæˆéšæœºæ•° 0-100
   â”œâ”€ è‹¥ â‰¤ 5 â†’ ç›´æ¥è¿”å› HTTP 500
   â”‚  â””â”€ ä¸è½¬å‘ç»™åç«¯ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°é”™è¯¯
   â”‚
   â””â”€ è‹¥ > 5 â†’ æ­£å¸¸è½¬å‘ç»™åç«¯

ï¼ˆè‹¥æ­£å¸¸è½¬å‘ï¼‰åç«¯å¤„ç†å¹¶å“åº”
   â†“
Envoy è¿”å›å“åº”
```

**å¸¸è§çš„ HTTP çŠ¶æ€ç ï¼š**

| çŠ¶æ€ç  | å«ä¹‰ | æµ‹è¯•ç”¨é€” |
|--------|------|---------|
| **500** | Internal Server Error | ä¸€èˆ¬æ€§æœåŠ¡æ•…éšœ |
| **503** | Service Unavailable | æœåŠ¡è¿‡è½½ |
| **504** | Gateway Timeout | ç½‘å…³è¶…æ—¶ï¼ˆå·²åœ¨ Envoy å±‚å¤„ç†ï¼‰ |
| **429** | Too Many Requests | é™æµï¼ˆå®¢æˆ·ç«¯åº”è¯¥é€€é¿ï¼‰ |
| **408** | Request Timeout | è¯·æ±‚è¶…æ—¶ |

### å»¶è¿Ÿä¸é”™è¯¯çš„ç»„åˆ

**æœ€å¼ºå¤§çš„æµ‹è¯•åœºæ™¯ï¼šåŒæ—¶æ³¨å…¥å»¶è¿Ÿå’Œé”™è¯¯ã€‚**

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: payment
spec:
  hosts:
  - payment
  http:
  - fault:
      delay:
        percentage: 20             # 20% è¯·æ±‚å»¶è¿Ÿ
        fixedDelay: 2s
      abort:
        percentage: 5              # 5% è¯·æ±‚é”™è¯¯ï¼ˆä»å‰©ä½™ 80% ä¸­é€‰ï¼‰
        httpStatus: 500
    route:
    - destination:
        host: payment
```

**å®é™…æ•ˆæœï¼š**

```
100 ä¸ªè¯·æ±‚ä¸­ï¼š
20 ä¸ªè¯·æ±‚ â†’ å»¶è¿Ÿ 2 ç§’åæ­£å¸¸å¤„ç†ï¼ˆæµ‹è¯•è¶…æ—¶å’Œé‡è¯•ï¼‰
80 ä¸ªæ­£å¸¸è¯·æ±‚ä¸­ï¼š
  4 ä¸ªè¯·æ±‚ â†’ è¿”å› 500 é”™è¯¯ï¼ˆæµ‹è¯•ç†”æ–­ï¼‰
  76 ä¸ªè¯·æ±‚ â†’ æ­£å¸¸å¤„ç†
```

**éªŒè¯æµ‹è¯•ç»“æœï¼š**

```bash
# è¿è¡Œä¸€ä¸ªæµ‹è¯•å®¢æˆ·ç«¯ï¼Œå‘é€å¤§é‡è¯·æ±‚
for i in {1..100}; do
  curl -v http://payment:8000/charge
  sleep 0.1
done

# è§‚å¯Ÿæ—¥å¿—ï¼š
# - å¤§çº¦ 20% çš„è¯·æ±‚è€—æ—¶ 2+ ç§’
# - å¤§çº¦ 5% çš„è¯·æ±‚è¿”å› 500
```

---

## 3. æ¡ä»¶åŒ–æ•…éšœæ³¨å…¥ï¼šç²¾ç¡®æ‰“å‡»

### æŒ‰ Header åŒ¹é…æ³¨å…¥æ•…éšœ

**åœºæ™¯ï¼š** ä½ åªæƒ³å¯¹ç‰¹å®šçš„æµ‹è¯•ç”¨æˆ·æ³¨å…¥æ•…éšœï¼Œç”Ÿäº§ç”¨æˆ·ä¸å—å½±å“ã€‚

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  # è§„åˆ™ 1ï¼šæµ‹è¯•ç”¨æˆ·è·å¾—æ•…éšœæ³¨å…¥
  - match:
    - headers:
        x-test-user:
          exact: "true"
    fault:
      delay:
        percentage: 50             # 50% çš„æµ‹è¯•è¯·æ±‚å»¶è¿Ÿ
        fixedDelay: 1s
      abort:
        percentage: 10
        httpStatus: 500
    route:
    - destination:
        host: reviews
  
  # è§„åˆ™ 2ï¼šç”Ÿäº§ç”¨æˆ·ä¸æ³¨å…¥æ•…éšœ
  - route:
    - destination:
        host: reviews
```

**å·¥ä½œæµç¨‹ï¼š**

```
å®¢æˆ·ç«¯è¯·æ±‚å¸¦ Header: x-test-user: true
   â†“
åŒ¹é…è§„åˆ™ 1 âœ“
   â†“
åº”ç”¨æ•…éšœæ³¨å…¥ï¼ˆ50% å»¶è¿Ÿï¼Œ10% é”™è¯¯ï¼‰
   â”œâ”€ æµ‹è¯•ç³»ç»Ÿçš„å®¹é”™èƒ½åŠ›
   â””â”€ éªŒè¯é‡è¯•ã€è¶…æ—¶ã€ç†”æ–­æ˜¯å¦å·¥ä½œ

å®¢æˆ·ç«¯è¯·æ±‚ä¸å¸¦ Header
   â†“
åŒ¹é…è§„åˆ™ 1 âœ—
   â†“
åŒ¹é…è§„åˆ™ 2ï¼ˆå…œåº•è§„åˆ™ï¼‰
   â†“
ä¸æ³¨å…¥æ•…éšœï¼Œæ­£å¸¸å¤„ç†
```

### æŒ‰æº Pod æ ‡ç­¾æ³¨å…¥æ•…éšœ

```yaml
- match:
  - sourceLabels:
      team: qa                    # ä»… QA å›¢é˜Ÿçš„è¯·æ±‚
  fault:
    delay:
      percentage: 100            # 100% å»¶è¿Ÿï¼ˆæ•…æ„è®©ä»–ä»¬ä½“éªŒæ•…éšœï¼‰
      fixedDelay: 2s
  route:
  - destination:
      host: reviews
```

### æŒ‰ URI è·¯å¾„æ³¨å…¥æ•…éšœ

```yaml
- match:
  - uri:
      prefix: "/api/test"         # ä»…æµ‹è¯•ç«¯ç‚¹
  fault:
    abort:
      percentage: 50
      httpStatus: 500
  route:
  - destination:
      host: reviews
```

---

## 4. æµé‡é•œåƒï¼ˆTraffic Mirroringï¼‰ï¼šå½±å­æµé‡æµ‹è¯•

### æµé‡é•œåƒçš„åŸç†

æµé‡é•œåƒï¼ˆä¹Ÿå«"shadowing"ï¼‰æ˜¯ä¸€ç§**ä½é£é™©**çš„ç”Ÿäº§æµ‹è¯•æŠ€æœ¯ï¼š

```
çœŸå®æµé‡è¢«**åŒæ—¶**å‘é€åˆ°ä¸¤ä¸ªç‰ˆæœ¬ï¼š
   â”œâ”€ ç‰ˆæœ¬ 1ï¼ˆå½“å‰ç”Ÿäº§ç‰ˆæœ¬ï¼‰
   â””â”€ ç‰ˆæœ¬ 2ï¼ˆæ–°ç‰ˆæœ¬ï¼Œæµ‹è¯•ä¸­ï¼‰

ç‰ˆæœ¬ 1 çš„å“åº”è¿”å›ç»™å®¢æˆ·ç«¯ï¼ˆç”¨æˆ·çœ‹åˆ°ç»“æœï¼‰
ç‰ˆæœ¬ 2 çš„å“åº”è¢«å¿½ç•¥ï¼ˆä»…ç”¨äºå†…éƒ¨æµ‹è¯•ï¼‰
```

**ä¼˜åŠ¿ï¼š**
- ç”¨çœŸå®æµé‡æµ‹è¯•æ–°ç‰ˆæœ¬
- ç”¨æˆ·æ— æ„ŸçŸ¥ï¼ˆå“åº”æ¥è‡ªç¨³å®šç‰ˆæœ¬ï¼‰
- å¯ä»¥å¯¹æ¯”ä¸¤ä¸ªç‰ˆæœ¬çš„æ—¥å¿—ã€æ€§èƒ½

### é…ç½®æµé‡é•œåƒ

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
  - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v1               # ä¸»æµé‡
      weight: 100
    
    # é•œåƒé…ç½®
    mirror:
      host: reviews
      subset: v2                 # é•œåƒåˆ° v2ï¼ˆæ–°ç‰ˆæœ¬ï¼‰
      port:
        number: 9080
    
    mirrorPercent: 100           # é•œåƒ 100% çš„æµé‡ï¼ˆå…¨é‡æµ‹è¯•ï¼‰
    # æˆ– mirrorPercentageï¼ˆIstio 1.6+ï¼‰ï¼šç›¸åŒå«ä¹‰
```

**å·¥ä½œæµç¨‹ï¼ˆæ—¶é—´è½´ï¼‰ï¼š**

```
æ—¶åˆ» T0ï¼šå®¢æˆ·ç«¯è¯·æ±‚ GET /reviews/1

æ—¶åˆ» T0+1msï¼š
  â”œâ”€ Envoy è½¬å‘è¯·æ±‚åˆ° reviews:v1ï¼ˆä¸»æµé‡ï¼‰
  â””â”€ Envoy **åŒæ—¶**è½¬å‘è¯·æ±‚åˆ° reviews:v2ï¼ˆé•œåƒæµé‡ï¼‰

æ—¶åˆ» T0+50msï¼š
  â”œâ”€ reviews:v1 è¿”å›å“åº”ï¼ˆ200 OK, åŒ…å«ä¹¦ç±è¯„åˆ†ï¼‰
  â””â”€ Envoy å°†å“åº”è¿”å›ç»™å®¢æˆ·ç«¯

æ—¶åˆ» T0+100msï¼š
  â”œâ”€ reviews:v2 ä¹Ÿè¿”å›å“åº”
  â””â”€ Envoy æ¥æ”¶ä½†**å¿½ç•¥**è¯¥å“åº”ï¼ˆä¸è¿”å›ç»™å®¢æˆ·ç«¯ï¼‰

ç»“æœï¼š
  å®¢æˆ·ç«¯æ”¶åˆ° v1 çš„å“åº”ï¼ˆç¨³å®šï¼‰
  ä½† v2 ä¹Ÿå¤„ç†äº†è¯·æ±‚ï¼ˆå¯ä»¥å®¡è®¡æ—¥å¿—æ¥æ¯”å¯¹ç»“æœï¼‰
```

### åˆ†é˜¶æ®µé•œåƒè®¡åˆ’

**é˜¶æ®µ 1ï¼šå°æµé‡éªŒè¯**

```yaml
mirrorPercent: 10              # ä»…é•œåƒ 10% çš„æµé‡
```

ä½¿ç”¨ï¼š
- å¿«é€ŸéªŒè¯æ–°ç‰ˆæœ¬åŸºæœ¬åŠŸèƒ½
- å‘ç°æ˜æ˜¾çš„ BUG
- æ£€æŸ¥æ–°ç‰ˆæœ¬æ˜¯å¦ä¼šå´©æºƒ

**é˜¶æ®µ 2ï¼šä¸­ç­‰æµé‡æµ‹è¯•**

```yaml
mirrorPercent: 50              # é•œåƒ 50% çš„æµé‡
```

ä½¿ç”¨ï¼š
- å¹¶å‘å‹åŠ›æµ‹è¯•
- æ€§èƒ½åŸºå‡†å¯¹æ¯”
- è¾¹ç•Œæ¡ä»¶æµ‹è¯•

**é˜¶æ®µ 3ï¼šå…¨é‡éªŒè¯**

```yaml
mirrorPercent: 100             # é•œåƒ 100% çš„æµé‡
```

ä½¿ç”¨ï¼š
- é•¿æœŸç¨³å®šæ€§æµ‹è¯•ï¼ˆè¿è¡Œ 1 å‘¨ï¼‰
- å®Œæ•´çš„ç”Ÿäº§æµé‡æ¨¡å¼éªŒè¯
- å‡†å¤‡åˆ‡æ¢åˆ°æ–°ç‰ˆæœ¬

**é˜¶æ®µ 4ï¼šé‡‘ä¸é›€å‘å¸ƒ**

```yaml
# VirtualService åˆ‡æ¢ä¸ºæƒé‡è·¯ç”±
route:
- destination:
    host: reviews
    subset: v1
  weight: 90                   # 90% ä¸»æµé‡
- destination:
    host: reviews
    subset: v2
  weight: 10                   # 10% æµ‹è¯•æµé‡ï¼ˆä¸å†é•œåƒï¼ŒçœŸå®ç”¨æˆ·ï¼‰
```

### æµé‡é•œåƒçš„æ³¨æ„äº‹é¡¹

**æ³¨æ„ 1ï¼šé•œåƒæµé‡ä¹Ÿæ¶ˆè€—èµ„æº**

```
åœºæ™¯ï¼šæ–°ç‰ˆæœ¬ v2 æœ‰ BUGï¼Œå¤„ç†å¾ˆæ…¢ï¼ˆæ¯ä¸ªè¯·æ±‚ 30sï¼‰
      â†“
      é•œåƒ 100% æµé‡åˆ° v2
      â†“
      v2 çš„ Pod è¢« 30s çš„å¤„ç†å¡ä½
      â†“
      Pod èµ„æºè€—å°½ï¼Œå¯èƒ½å½±å“å…¶ä»–æœåŠ¡ï¼ˆå¦‚æœåœ¨åŒä¸€èŠ‚ç‚¹ï¼‰
      
è§£å†³æ–¹æ¡ˆï¼š
1. ç»™ v2 åˆ†é…è¶³å¤Ÿçš„èµ„æº
2. éƒ¨ç½²åˆ°ç‹¬ç«‹èŠ‚ç‚¹
3. é™åˆ¶é•œåƒæ¯”ä¾‹ï¼ˆä¸è¦ 100%ï¼‰
```

**æ³¨æ„ 2ï¼šå¹‚ç­‰æ€§**

```yaml
# âŒ é”™è¯¯ï¼šé•œåƒ POST è¯·æ±‚ï¼ˆåˆ›å»ºæ–°èµ„æºï¼‰
mirrorPercent: 100
# ç»“æœï¼šæ¯ä¸ªåˆ›å»ºæ“ä½œä¼šé‡å¤æ‰§è¡Œï¼ˆé•œåƒä¸€æ¬¡ = é¢å¤–åˆ›å»ºä¸€æ¬¡ï¼‰

# âœ“ æ­£ç¡®ï¼šä»…é•œåƒ GETã€HEADï¼ˆæŸ¥è¯¢æ“ä½œï¼‰
match:
- method:
    exact: GET
mirror:
  host: reviews
  subset: v2
mirrorPercent: 100
```

---

## 5. å¯è§‚æµ‹æ€§ï¼šè§‚å¯Ÿç³»ç»Ÿè¡Œä¸º

### å¯è§‚æµ‹æ€§çš„ä¸‰ä¸ªæ”¯æŸ±

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       å¯è§‚æµ‹æ€§ï¼ˆObservabilityï¼‰       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  1. æ—¥å¿—ï¼ˆLogsï¼‰                    â”‚
â”‚     â””â”€ "å‘ç”Ÿäº†ä»€ä¹ˆäº‹ä»¶ï¼Ÿ"           â”‚
â”‚                                     â”‚
â”‚  2. æŒ‡æ ‡ï¼ˆMetricsï¼‰                 â”‚
â”‚     â””â”€ "ç³»ç»Ÿè¡¨ç°å¦‚ä½•ï¼Ÿ"             â”‚
â”‚                                     â”‚
â”‚  3. è¿½è¸ªï¼ˆTracesï¼‰                  â”‚
â”‚     â””â”€ "è¯·æ±‚ç»è¿‡äº†å“ªäº›æœåŠ¡ï¼Ÿ"       â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Istio çš„æ—¥å¿—æ”¶é›†

#### Envoy è®¿é—®æ—¥å¿—

æ¯ä¸€ä¸ªé€šè¿‡ Envoy çš„è¯·æ±‚éƒ½ä¼šè¢«è®°å½•ï¼š

```bash
# æŸ¥çœ‹ Sidecar æ—¥å¿—
kubectl logs -n bookinfo <pod-name> -c istio-proxy

# è¾“å‡ºç¤ºä¾‹ï¼š
# [2026-02-08T10:20:00.000Z] "GET /reviews/1 HTTP/1.1" 200 - 0 256 50 45 "-" "curl/7.85.0" "abc123" "reviews:9080" "10.0.1.5:9080"
```

**æ—¥å¿—å­—æ®µè§£é‡Šï¼š**

```
[æ—¶é—´æˆ³]                               2026-02-08T10:20:00.000Z
"HTTPæ–¹æ³• è·¯å¾„ åè®®"                   GET /reviews/1 HTTP/1.1
HTTPå“åº”ç                              200
å“åº”ç è¯¦æƒ…ï¼ˆä»…æŸäº›protocolç”Ÿæ•ˆï¼‰       -
è¯·æ±‚ä½“å­—èŠ‚æ•°                           0
å“åº”ä½“å­—èŠ‚æ•°                           256
å¤„ç†æ—¶é—´(ms)                           50
TCPè¿æ¥å»ºç«‹æ—¶é—´(ms)                    45
Referrer                              -
User-Agent                            curl/7.85.0
RequestID/X-Request-ID                abc123
Authority/ç›®æ ‡Host                    reviews:9080
ä¸Šæ¸¸å®ä¾‹IP:Port                        10.0.1.5:9080
```

**å¯ç”¨è¯¦ç»†çš„è®¿é—®æ—¥å¿—ï¼š**

```yaml
# ä¸ºæ•´ä¸ªç½‘æ ¼å¯ç”¨è®¿é—®æ—¥å¿—
apiVersion: telemetry.istio.io/v1alpha1
kind: Telemetry
metadata:
  name: custom-logging
  namespace: bookinfo
spec:
  accessLogging:
  - providers:
    - name: envoy        # ä½¿ç”¨ Envoy çš„è®¿é—®æ—¥å¿—
    match:
      metrics:
      - REQUEST_PATH     # è®°å½•è¯·æ±‚è·¯å¾„
      - RESPONSE_CODE    # è®°å½•å“åº”ç 
      - SOURCE_ADDRESS   # è®°å½•æ¥æºåœ°å€
```

#### åº”ç”¨æ—¥å¿—å…³è”

åœ¨å®¹å™¨æ—¥å¿—ä¸­åŒ…å« **X-Request-ID** å¯ä»¥å…³è”åº”ç”¨æ—¥å¿—ä¸ Envoy æ—¥å¿—ï¼š

```yaml
# Deployment ä¸­é…ç½®
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reviews-v1
spec:
  template:
    spec:
      containers:
      - name: reviews
        env:
        - name: ENABLE_JAEGER_LOGS
          value: "true"  # å¯ç”¨è¯·æ±‚è¿½è¸ª
```

### æŒ‡æ ‡ï¼ˆMetricsï¼‰æ”¶é›†

Envoy è‡ªåŠ¨ç”Ÿæˆå…³é”®æŒ‡æ ‡ï¼š

```
istio_request_total{...}           # è¯·æ±‚æ€»æ•°
istio_request_duration_milliseconds # è¯·æ±‚å»¶è¿Ÿåˆ†å¸ƒ
istio_response_bytes{...}          # å“åº”å­—èŠ‚æ•°
envoy_http_inbound_0_0_0_0_80_rq   # å…¥ç«™è¯·æ±‚
envoy_cluster_upstream_rq_time      # ä¸Šæ¸¸å“åº”æ—¶é—´
```

**æŸ¥çœ‹æŒ‡æ ‡ï¼š**

```bash
# æ–¹æ³• 1ï¼šé€šè¿‡ Envoy Admin æ¥å£
kubectl port-forward -n bookinfo <pod-name> 15000:15000
curl http://localhost:15000/stats | grep istio_request_total

# æ–¹æ³• 2ï¼šé€šè¿‡ Prometheusï¼ˆå¦‚æœå®‰è£…äº†ï¼‰
kubectl port-forward -n istio-system svc/prometheus 9090:9090
# è®¿é—® http://localhost:9090ï¼ŒæŸ¥è¯¢ï¼š
# sum(rate(istio_request_total[5m])) by (destination_service)
```

### åˆ†å¸ƒå¼è¿½è¸ªï¼ˆDistributed Tracingï¼‰

è¿½è¸ªè¿½è¸ªå•ä¸ªè¯·æ±‚åœ¨å¤šä¸ªæœåŠ¡é—´çš„å®Œæ•´è·¯å¾„ï¼š

```
å®¢æˆ·ç«¯å‘é€è¯·æ±‚
   â†“
API Gateway æ”¶åˆ°è¯·æ±‚
  åˆ›å»º Trace IDï¼ˆä¾‹å¦‚ï¼šabc123ï¼‰
  è®°å½• Spanï¼š[API Gateway] å¤„ç†æ—¶é—´ 50ms
   â†“
API Gateway è°ƒç”¨ productpage
  è½¬å‘ Trace ID åœ¨ Header ä¸­
  è®°å½• Spanï¼š[productpage] å¤„ç†æ—¶é—´ 100ms
   â†“
productpage è°ƒç”¨ details
  è½¬å‘ Trace ID
  è®°å½• Spanï¼š[details] å¤„ç†æ—¶é—´ 30ms
   â†“
productpage è°ƒç”¨ reviews
  è½¬å‘ Trace ID
  è®°å½• Spanï¼š[reviews] å¤„ç†æ—¶é—´ 40ms
   â†“
è¯·æ±‚è¿”å›
   â†“
Trace å®Œæˆï¼ˆ5 ä¸ª Spanï¼‰ï¼š
è¯·æ±‚æ€»è€—æ—¶ = 50 + 100 + max(30, 40) = 190ms
      â†‘
   å¹¶è¡Œå¤„ç†
```

**å¯ç”¨è¿½è¸ªï¼š**

```bash
# Istio é»˜è®¤é‡‡æ ·ç‡ä¸º 1%ï¼ˆ1 å‡º 100 ä¸ªè¯·æ±‚è¢«è¿½è¸ªï¼‰
# æŸ¥çœ‹ Jaeger UI
kubectl port-forward -n istio-system svc/jaeger 16686:16686

# è®¿é—® http://localhost:16686
# é€‰æ‹© Service: productpage
# æœç´¢ Trace
```

**ç”Ÿæˆå¯è¿½è¸ªçš„è¯·æ±‚ï¼š**

```bash
# å¿…é¡»åœ¨è¯·æ±‚ä¸­åŒ…å«ä»¥ä¸‹ Header ä¹‹ä¸€ï¼Œæ‰èƒ½è¢«è¿½è¸ªç³»ç»Ÿè¯†åˆ«ï¼š
curl -v \
  -H "x-request-id: test-123" \
  -H "x-b3-traceid: test-123" \
  -H "x-ot-span-context: test-123" \
  http://productpage:8000/productpage
```

---

## 6. ç»¼åˆè¯Šæ–­å·¥ä½œæµ

### åœºæ™¯ï¼šå“åº”å»¶è¿Ÿçªå¢

**ç—‡çŠ¶ï¼š** åº”ç”¨çªç„¶å˜æ…¢ï¼Œå¹³å‡å“åº”æ—¶é—´ä» 50ms å˜æˆ 500msã€‚

**è¯Šæ–­æ­¥éª¤ï¼š**

```bash
# æ­¥éª¤ 1ï¼šæ£€æŸ¥æ˜¯å¦æ³¨å…¥äº†æ•…éšœ
kubectl get vs -n bookinfo
kubectl get dr -n bookinfo
istioctl get virtualservice -n bookinfo productpage -o yaml | grep fault

# æ­¥éª¤ 2ï¼šæŸ¥çœ‹ Envoy æ—¥å¿—ï¼Œç¡®è®¤å»¶è¿Ÿæºå¤´
kubectl logs -n bookinfo productpage-v1-xxx -c istio-proxy | tail -20

# è¾“å‡ºä¸­æŸ¥æ‰¾ï¼š
# - å¤„ç†æ—¶é—´ï¼ˆç¬¬ 9 ä¸ªå­—æ®µï¼‰æ˜¯å¦éƒ½å¾ˆå¤§ï¼Ÿ
# - TCP å»ºç«‹æ—¶é—´ï¼ˆç¬¬ 10 ä¸ªå­—æ®µï¼‰æ˜¯å¦å¾ˆå¤§ï¼Ÿï¼ˆè¡¨ç¤ºç½‘ç»œé—®é¢˜ï¼‰

# æ­¥éª¤ 3ï¼šæ£€æŸ¥ä¸Šæ¸¸æœåŠ¡æ˜¯å¦æ•…éšœ
istioctl proxy-config endpoints -n bookinfo productpage-v1-xxx | grep details

# è¾“å‡ºåº”è¯¥æ˜¾ç¤ºæ‰€æœ‰ details Pod çš„çŠ¶æ€ï¼ˆHEALTHY æˆ–éš”ç¦»ä¸­ï¼‰
# å¦‚æœéƒ½éš”ç¦»äº†ï¼Œè¯´æ˜ details æœåŠ¡æ•…éšœ

# æ­¥éª¤ 4ï¼šæ£€æŸ¥ç†”æ–­æ˜¯å¦è§¦å‘
kubectl port-forward -n bookinfo productpage-v1-xxx 15000:15000 &
curl http://localhost:15000/stats | grep details | grep ejection

# è‹¥è¾“å‡º ejection è®¡æ•° > 0ï¼Œè¯´æ˜ç†”æ–­å·²è§¦å‘

# æ­¥éª¤ 5ï¼šæ£€æŸ¥åº”ç”¨è‡ªèº«æ˜¯å¦æœ‰é—®é¢˜
kubectl exec -it -n bookinfo productpage-v1-xxx -c productpage -- curl http://localhost:8000/health

# å¦‚æœ health check å¤±è´¥ï¼Œè¯´æ˜åº”ç”¨æœ¬èº«æœ‰é—®é¢˜
```

**æ ¹æœ¬åŸå› åˆ†æï¼ˆRCAï¼‰ï¼š**

```
å¯èƒ½çš„åŸå› åŠéªŒè¯æ–¹æ³•ï¼š

1. ç½‘ç»œé—®é¢˜
   éªŒè¯ï¼šTCP å»ºç«‹æ—¶é—´æ˜¯å¦å¤§äºé€šå¸¸å€¼ï¼Ÿ
   æ£€æŸ¥ï¼škubectl get nodesï¼Œæ˜¯å¦æœ‰èŠ‚ç‚¹èµ„æºä¸è¶³ï¼Ÿ

2. åç«¯æœåŠ¡æ•…éšœ
   éªŒè¯ï¼šä¸Šæ¸¸æœåŠ¡ Pod æ˜¯å¦éƒ½è¢«éš”ç¦»ï¼ˆç†”æ–­ï¼‰ï¼Ÿ
   æ£€æŸ¥ï¼škubectl logs -c <container> æŸ¥çœ‹åº”ç”¨æ—¥å¿—

3. æ•…éšœæ³¨å…¥é…ç½®
   éªŒè¯ï¼šæ˜¯å¦æœ‰ fault é…ç½®ï¼Ÿ
   æ£€æŸ¥ï¼šistioctl get vs -o yaml

4. è¿æ¥æ± é™åˆ¶
   éªŒè¯ï¼šæ˜¯å¦ç»å¸¸çœ‹åˆ° UOï¼ˆUpstream Overflowï¼‰é”™è¯¯ï¼Ÿ
   æ£€æŸ¥ï¼šistioctl proxy-config cluster çš„ maxPendingRequests

5. é™æµ
   éªŒè¯ï¼šæ˜¯å¦çœ‹åˆ° HTTP 429ï¼ˆToo Many Requestsï¼‰ï¼Ÿ
   æ£€æŸ¥ï¼šè¿æ¥æ± æ˜¯å¦å·²æ»¡ï¼Ÿ
```

---

## 7. å¸¸è§æ•…éšœæ³¨å…¥é™·é˜±

### é™·é˜± 1ï¼šæ•…éšœæ³¨å…¥å½±å“ç”Ÿäº§ç”¨æˆ·

```yaml
# âŒ é”™è¯¯ï¼šæ— æ¡ä»¶æ³¨å…¥æ•…éšœ
fault:
  delay:
    percentage: 50
    fixedDelay: 5s
# ç»“æœï¼š50% çš„ç”Ÿäº§ç”¨æˆ·ç»å† 5 ç§’å»¶è¿Ÿï¼

# âœ“ æ­£ç¡®ï¼šä»…å¯¹æµ‹è¯•ç”¨æˆ·æ³¨å…¥
- match:
  - headers:
      x-test-user:
        exact: "true"
  fault:
    delay:
      percentage: 50
      fixedDelay: 5s
```

### é™·é˜± 2ï¼šæ•…éšœæ³¨å…¥å¼ºåº¦è¿‡é«˜

```yaml
# âŒ é”™è¯¯ï¼š100% æ•…éšœ
fault:
  abort:
    percentage: 100            # 100% è¯·æ±‚éƒ½å¤±è´¥ï¼
    httpStatus: 500

# âœ“ æ­£ç¡®ï¼šé€‚åº¦æµ‹è¯•
fault:
  abort:
    percentage: 10             # 10% è¶³ä»¥æµ‹è¯•å®¹é”™
    httpStatus: 500
```

### é™·é˜± 3ï¼šé—å¿˜å…³é—­æ•…éšœæ³¨å…¥

```yaml
# âŒ é”™è¯¯ï¼šæµ‹è¯•å®Œæˆåå¿˜è®°åˆ é™¤
fault:
  delay:
    percentage: 50
    fixedDelay: 5s
# åº”ç”¨ä¸Šçº¿åä»åœ¨è¿è¡Œï¼

# âœ“ æ­£ç¡®ï¼šæµ‹è¯•å®Œæˆååˆ é™¤
kubectl delete vs reviews -n bookinfo
```

### é™·é˜± 4ï¼šé•œåƒæµé‡å‹å®æ–°ç‰ˆæœ¬

```yaml
# âŒ é”™è¯¯ï¼šæ–°ç‰ˆæœ¬åªæœ‰ 1 ä¸ªå‰¯æœ¬ï¼Œä½†é•œåƒ 100% æµé‡
mirrorPercent: 100
# ç»“æœï¼šæ–°ç‰ˆæœ¬ Pod å¤„ç† 200% çš„æµé‡ï¼ˆåŸæœ‰ + é•œåƒï¼‰â†’ å´©æºƒ

# âœ“ æ­£ç¡®ï¼šç¡®ä¿æ–°ç‰ˆæœ¬æœ‰è¶³å¤Ÿèµ„æº
# 1. å¢åŠ å‰¯æœ¬æ•°
# 2. åˆ†é˜¶æ®µå¢åŠ é•œåƒæ¯”ä¾‹ï¼ˆ10% â†’ 50% â†’ 100%ï¼‰
```

---

## 8. æœ¬ç« å°ç»“

### æ•…éšœæ³¨å…¥å¿«é€Ÿå‚è€ƒ

```yaml
# å»¶è¿Ÿæ³¨å…¥ï¼ˆæµ‹è¯•è¶…æ—¶å’Œé‡è¯•ï¼‰
fault:
  delay:
    percentage: 10
    fixedDelay: 500ms

# é”™è¯¯æ³¨å…¥ï¼ˆæµ‹è¯•ç†”æ–­å’Œé”™è¯¯å¤„ç†ï¼‰
fault:
  abort:
    percentage: 5
    httpStatus: 500

# æ¡ä»¶åŒ–æ³¨å…¥ï¼ˆä»…æµ‹è¯•ç”¨æˆ·ï¼‰
- match:
  - headers:
      x-test-user:
        exact: "true"
  fault:
    delay:
      percentage: 100
      fixedDelay: 1s
```

### æµé‡é•œåƒå¿«é€Ÿå‚è€ƒ

```yaml
# é˜¶æ®µ 1ï¼šå°æµé‡éªŒè¯ï¼ˆ10%ï¼‰
mirror:
  host: reviews
  subset: v2
mirrorPercent: 10

# é˜¶æ®µ 2ï¼šä¸­ç­‰æµé‡ï¼ˆ50%ï¼‰
mirrorPercent: 50

# é˜¶æ®µ 3ï¼šå…¨é‡éªŒè¯ï¼ˆ100%ï¼‰
mirrorPercent: 100

# é˜¶æ®µ 4ï¼šåˆ‡æ¢ä¸ºé‡‘ä¸é›€ï¼ˆçœŸå®ç”¨æˆ· 10% ç”¨æ–°ç‰ˆæœ¬ï¼‰
route:
- destination:
    host: reviews
    subset: v1
  weight: 90
- destination:
    host: reviews
    subset: v2
  weight: 10
```

### å¯è§‚æµ‹æ€§æ¸…å•

```bash
# æ—¥å¿—
kubectl logs -n bookinfo <pod> -c istio-proxy

# æŒ‡æ ‡
kubectl port-forward svc/prometheus 9090:9090
# æŸ¥è¯¢ï¼šsum(rate(istio_request_total[5m])) by (destination_service)

# è¿½è¸ª
kubectl port-forward svc/jaeger 16686:16686
# è®¿é—® http://localhost:16686

# å®æ—¶ç»Ÿè®¡
kubectl port-forward <pod> 15000:15000
curl http://localhost:15000/stats | grep istio
```

### è¯Šæ–­å·¥ä½œæµï¼ˆå¿«é€Ÿå‚è€ƒï¼‰

```bash
# é—®é¢˜ï¼šè¯·æ±‚è¶…æ—¶/å»¶è¿Ÿ

# 1. æ£€æŸ¥æ˜¯å¦æœ‰æ•…éšœæ³¨å…¥
istioctl get vs -o yaml | grep fault

# 2. æŸ¥çœ‹ Envoy æ—¥å¿—ï¼Œæ‰¾å‡ºå“ªä¸ªæœåŠ¡æ…¢
kubectl logs <pod> -c istio-proxy | grep "50[0-9]"

# 3. æ£€æŸ¥ç†”æ–­æ˜¯å¦è§¦å‘
kubectl port-forward <pod> 15000:15000
curl http://localhost:15000/stats | grep ejection

# 4. æ£€æŸ¥è¿æ¥æ± æ˜¯å¦æ»¡
curl http://localhost:15000/stats | grep upstream_rq_pending

# 5. æ£€æŸ¥åç«¯æœåŠ¡å¥åº·çŠ¶å†µ
istioctl proxy-config endpoints <pod> | grep HEALTHY
```

---

## 9. ä¸‹ä¸€æ­¥

ç¬¬å…­ç« å°†æ·±å…¥è®²è§£ï¼š
- **mTLS ä¸è¯ä¹¦ç®¡ç†**ï¼šå¦‚ä½•è‡ªåŠ¨åŠ å¯†æ‰€æœ‰ç½‘æ ¼å†…æµé‡
- **è®¤è¯ï¼ˆAuthenticationï¼‰**ï¼šéªŒè¯è¯·æ±‚çš„çœŸå®èº«ä»½
- **æˆæƒï¼ˆAuthorizationï¼‰**ï¼šç»†ç²’åº¦çš„è®¿é—®æ§åˆ¶

æŒæ¡è¿™äº›ï¼Œä½ å°±èƒ½ä¿æŠ¤å¾®æœåŠ¡ç³»ç»Ÿä»ç½‘ç»œå±‚åˆ°åº”ç”¨å±‚ã€‚ ğŸš€
